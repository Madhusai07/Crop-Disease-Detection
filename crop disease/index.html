<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Crop Disease Detection & Alert System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Set theme on initial load to prevent flash of wrong theme
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-container {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .module-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        .nav-btn.active {
            background-color: #16a34a; /* green-600 */
            color: white;
        }
        .nav-btn.active svg {
            color: white;
        }
        .nav-container-mobile {
            overflow-x: auto;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-slate-200 transition-colors duration-300">

    <div id="app" class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1499529112087-3cb3b73cec95?q=80&w=1974&auto=format&fit=crop');">

        <div id="auth-container" class="w-full max-w-md">
            <div id="login-form" class="bg-white/80 dark:bg-slate-800/80 form-container p-8 rounded-2xl shadow-2xl">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-green-700 dark:text-green-500">CropGuard AI</h1>
                    <p class="text-gray-600 dark:text-slate-300 mt-2">Welcome Back, Farmer!</p>
                </div>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="you@farm.com" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="••••••••" required>
                    </div>
                     <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-md dark:hover:bg-green-500">Login</button>
                    <p class="text-center text-sm text-gray-600 dark:text-slate-400 mt-6">
                        Don't have an account? <a href="#" id="show-register" class="font-medium text-green-600 dark:text-green-500 hover:underline">Register here</a>
                    </p>
                </form>
            </div>
            
            <div id="register-form" class="hidden bg-white/80 dark:bg-slate-800/80 form-container p-8 rounded-2xl shadow-2xl">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-green-700 dark:text-green-500">Join CropGuard AI</h1>
                    <p class="text-gray-600 dark:text-slate-300 mt-2">Create your account to get started.</p>
                </div>
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label for="register-name" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Full Name</label>
                        <input type="text" id="register-name" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="John Doe" required />
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Email</label>
                        <input type="email" id="register-email" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="you@farm.com" required />
                    </div>
                    <div>
                        <label for="register-phone" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Phone Number</label>
                        <input type="tel" id="register-phone" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="+919876543210" required />
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Password</label>
                        <input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" required />
                        <span id="password-strength" class="text-xs mt-1 block"></span>
                    </div>
                    <p id="register-error" class="text-red-500 text-sm text-center hidden"></p>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-md dark:hover:bg-green-500">Create Account</button>
                    <p class="text-center text-sm text-gray-600 dark:text-slate-400 mt-6">
                        Already have an account? <a href="#" id="show-login" class="font-medium text-green-600 dark:text-green-500 hover:underline">Login here</a>
                    </p>
                </form>
            </div>
        </div>

        <div id="app-container" class="hidden w-full max-w-7xl mx-auto">
            <header class="flex justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-xl shadow-lg mb-6">
                <h1 class="text-2xl font-bold text-green-700 dark:text-green-500">CropGuard AI</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.706-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.464A1 1 0 106.465 13.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414-2.12a1 1 0 011.414 0l.706.707a1 1 0 11-1.414 1.414l-.706-.707a1 1 0 010-1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" /></svg>
                        <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer mx-2">
                            <input type="checkbox" id="theme-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                    </div>
                    <span id="user-greeting" class="text-gray-700 dark:text-slate-300 hidden sm:inline"></span>
                    <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-medium">Logout</button>
                </div>
            </header>
            
            <div class="md:flex md:gap-6">
                 <aside class="w-full md:w-1/4 lg:w-1/5 mb-6 md:mb-0">
                    <nav id="module-nav" class="bg-white dark:bg-slate-800 p-2 md:p-4 rounded-xl shadow-lg">
                        <div class="md:hidden nav-container-mobile p-1">
                            <div class="flex items-center gap-2">
                                <button data-target="panel-detection" class="nav-btn active flex-shrink-0 text-center px-3 py-2 rounded-lg text-sm">Detect</button>
                                <button data-target="panel-context" class="nav-btn flex-shrink-0 text-center px-3 py-2 rounded-lg text-sm">Context</button>
                                <button data-target="panel-alert" class="nav-btn flex-shrink-0 text-center px-3 py-2 rounded-lg text-sm">Alert</button>
                                <button data-target="panel-history" class="nav-btn flex-shrink-0 text-center px-3 py-2 rounded-lg text-sm">History</button>
                                <button data-target="panel-outbreak" class="nav-btn flex-shrink-0 text-center px-3 py-2 rounded-lg text-sm">Outbreaks</button>
                                <button data-target="panel-community" class="nav-btn flex-shrink-0 text-center px-3 py-2 rounded-lg text-sm">Community</button>
                                <button data-target="panel-market" class="nav-btn flex-shrink-0 text-center px-3 py-2 rounded-lg text-sm">Market</button>
                                <button data-target="panel-schedule" class="nav-btn flex-shrink-0 text-center px-3 py-2 rounded-lg text-sm">Schedule</button>
                            </div>
                        </div>
                        <div class="hidden md:flex flex-col space-y-2">
                             <button data-target="panel-detection" class="nav-btn active w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 font-semibold flex items-center gap-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" /></svg>
                                 Detect Disease
                            </button>
                             <button data-target="panel-context" class="nav-btn w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 font-semibold flex items-center gap-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                 Context
                            </button>
                             <button data-target="panel-alert" class="nav-btn w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 font-semibold flex items-center gap-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                                 Alert
                            </button>
                             <button data-target="panel-history" class="nav-btn w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 font-semibold flex items-center gap-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                 History & Logs
                            </button>
                            <button data-target="panel-outbreak" class="nav-btn w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 font-semibold flex items-center gap-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                 Outbreak Alerts
                            </button>
                            <button data-target="panel-community" class="nav-btn w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 font-semibold flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                Community
                            </button>
                            <button data-target="panel-market" class="nav-btn w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 font-semibold flex items-center gap-3">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                Market
                            </button>
                            <button data-target="panel-schedule" class="nav-btn w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 font-semibold flex items-center gap-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-4 18h4M3 9h18M5 13h14M7 17h10M7 21h10M7 3h10a2 2 0 012 2v14a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2z" /></svg>
                                 Spray Schedule
                            </button>
                        </div>
                    </nav>
                </aside>
                
                <main id="modules-container" class="w-full md:w-3/4 lg:w-4/5">
                    <div id="panel-detection" class="module-panel">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 dark:text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" /></svg>
                                Upload an Image to Analyze
                            </h2>
                            <div class="flex flex-col md:flex-row items-center gap-6">
                                <div class="w-full md:w-1/2">
                                    <div class="mb-4">
                                        <label for="crop-type" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">
                                            1. Select your Crop
                                        </label>
                                        <select id="crop-type" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                            <option value="Unknown">Select a crop...</option>
                                            <option value="Tomato">Tomato</option>
                                            <option value="Potato">Potato</option>
                                            <option value="Apple">Apple</option>
                                            <option value="Rice">Rice</option>
                                            <option value="Maize (Corn)">Maize (Corn)</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>

                                    <label for="crop-image-upload" class="cursor-pointer block w-full h-64 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-lg flex flex-col justify-center items-center text-center hover:bg-gray-50 dark:hover:bg-slate-700">
                                        <img id="image-preview" src="" alt="Crop Preview" class="hidden max-h-full max-w-full rounded-lg">
                                        <div id="upload-placeholder">
                                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                            <p class="mt-2 text-sm text-gray-600 dark:text-slate-400">2. Click to upload an image</p>
                                            <p class="text-xs text-gray-500 dark:text-slate-500">PNG, JPG, GIF up to 10MB</p>
                                        </div>
                                    </label>
                                    <input id="crop-image-upload" type="file" class="hidden" accept="image/*">
                                </div>
                                
                                <div id="detection-result" class="w-full md:w-1/2 p-4 bg-gray-50 dark:bg-slate-700 rounded-lg min-h-[16rem] flex flex-col justify-center">
                                    <p id="result-placeholder" class="text-center text-gray-500 dark:text-slate-400">3. Analysis results will appear here.</p>
                                    <div id="result-content" class="hidden">
                                        <div id="spinner" class="hidden animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto my-4"></div>
                                        <p id="analysis-status" class="text-center text-sm text-gray-500 dark:text-slate-400 hidden"></p>
                                        
                                        <div id="result-details" class="hidden">
                                            <h3 class="font-bold text-lg text-gray-800 dark:text-slate-200" id="disease-name"></h3>

                                            <div class="flex flex-wrap gap-4 my-2 text-sm">
                                                <div>
                                                    <strong>Confidence:</strong>
                                                    <span id="confidence-score" class="font-semibold text-blue-600 dark:text-blue-400"></span>
                                                </div>
                                                <div id="severity-wrapper">
                                                    <strong>Severity:</strong>
                                                    <span id="severity-level" class="font-semibold px-2 py-0.5 rounded-full"></span>
                                                </div>
                                                <div id="type-wrapper">
                                                    <strong>Type:</strong>
                                                    <span id="disease-type" class="font-semibold text-gray-700 dark:text-slate-300"></span>
                                                </div>
                                            </div>

                                            <div class="mt-4 space-y-3">
                                                <div class="border-t dark:border-slate-600 pt-2">
                                                    <h4 class="font-semibold text-green-700 dark:text-green-500">Recommended Chemical Treatment</h4>
                                                    <p id="chemical-rec" class="text-sm text-gray-700 dark:text-slate-300"></p>
                                                </div>
                                                
                                                <div class="border-t dark:border-slate-600 pt-2">
                                                    <h4 class="font-semibold text-cyan-700 dark:text-cyan-500">Recommended Organic Treatment</h4>
                                                    <p id="organic-rec" class="text-sm text-gray-700 dark:text-slate-300"></p>
                                                </div>

                                                <div class="border-t dark:border-slate-600 pt-2">
                                                    <h4 id="prevention-title" class="font-semibold text-gray-600 dark:text-slate-400">Prevention Tip</h4>
                                                    <p id="prevention-tip" class="text-sm text-gray-700 dark:text-slate-300"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="panel-context" class="module-panel hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                                <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>
                                    Environmental Context
                                </h2>
                                
                                <div id="weather-content" class="space-y-4">
                                    <p id="weather-placeholder" class="text-center text-gray-500 dark:text-slate-400">Awaiting detection...</p>
                                    
                                    <div id="current-weather-details" class="hidden">
                                        <h4 class="font-semibold mb-1">Current Conditions</h4>
                                        <div id="weather-basics" class="text-sm"></div>
                                    </div>
                                    
                                    <div id="weather-risk-assessment" class="hidden">
                                        <h4 class="font-semibold mb-1 text-blue-600 dark:text-blue-400">AI-Powered Risk Analysis</h4>
                                        <div id="risk-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
                                        <p id="risk-assessment-text" class="text-sm p-3 bg-blue-50 dark:bg-blue-900/50 rounded-lg"></p>
                                    </div>
                                </div>

                            </div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                                <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    Geographic Location
                                </h2>
                                <div id="map-content" class="text-center text-gray-500 dark:text-slate-400">Awaiting detection...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="panel-alert" class="module-panel hidden">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                                Alert & Notification Module
                            </h2>
                             <div id="alert-system" class="space-y-4">
                                
                                <div>
                                    <label for="alert-phone" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Send to Phone Number</label>
                                    <input type="tel" id="alert-phone" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="+919876543210">
                                    <p class="text-xs text-gray-500 dark:text-slate-400 mt-1">Defaults to your registered number. You can change it to alert someone else.</p>
                                </div>

                                <div>
                                    <label for="alert-message" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Alert Message (Editable)</label>
                                    <textarea id="alert-message" rows="4" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg"></textarea>
                                </div>
                                
                                <button id="send-alert-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-500 transition-colors font-semibold disabled:bg-gray-400 dark:disabled:bg-slate-600" disabled>Send SMS Alert</button>
                             </div>
                        </div>
                    </div>

                    <!-- History Panel (ADVANCED) -->
                    <div id="panel-history" class="module-panel hidden">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500 fill-none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                Advanced Detection History & Treatment Logs
                            </h2>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <select id="filter-crop" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg text-sm">
                                    <option value="All">Filter by Crop: All</option>
                                    <option value="Tomato">Tomato</option>
                                    <option value="Potato">Potato</option>
                                    <option value="Apple">Apple</option>
                                    <option value="Rice">Rice</option>
                                    <option value="Maize (Corn)">Maize (Corn)</option>
                                    <option value="Other">Other</option>
                                </select>
                                <select id="filter-severity" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg text-sm">
                                    <option value="All">Filter by Severity: All</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                    <option value="Not Applicable">Not Applicable</option>
                                </select>
                                <button id="clear-filters-btn" class="bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-slate-300 py-2 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-slate-600">Clear Filters</button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- History List (Left Column) -->
                                <div class="md:col-span-1 border-r dark:border-slate-700 pr-4 max-h-[60vh] overflow-y-auto">
                                    <div id="history-list" class="space-y-3 pb-4">
                                        <p id="history-placeholder" class="text-center text-gray-500 dark:text-slate-400">Loading history...</p>
                                    </div>
                                </div>
                                
                                <!-- History Detail (Right Two Columns) -->
                                <div class="md:col-span-2">
                                    <h3 class="font-semibold text-lg text-green-700 dark:text-green-500 mb-3">Detection Details</h3>
                                    <div id="history-detail-view" class="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg min-h-[300px]">
                                        <p class="text-center text-gray-500 dark:text-slate-400 mt-12">Select an entry from the left to view full details and logs.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="panel-outbreak" class="module-panel hidden">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Personalized Outbreak Alerts
                            </h2r>
                            <div id="outbreak-alert-container" class="space-y-3">
                                 <p id="outbreak-placeholder" class="text-center text-gray-500 dark:text-slate-400">No significant recurring threats detected in your history.</p>
                            </div>
                        </div>
                    </div>

                    <div id="panel-community" class="module-panel hidden">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                Community Hub
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <h3 class="font-semibold mb-2">Local Farmer Chat</h3>
                                    <div class="bg-gray-100 dark:bg-slate-700 h-80 rounded-lg p-4 flex flex-col">
                                        <div id="chat-messages" class="flex-grow space-y-4 overflow-y-auto pr-2">
                                            </div>
                                        <form id="chat-form" class="mt-4 flex gap-2">
                                            <input type="text" id="chat-input" placeholder="Type your message..." class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-lg" required>
                                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold">Send</button>
                                        </form>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold mb-2">Expert Connect</h3>
                                    <div class="bg-blue-100 dark:bg-blue-900/50 p-4 rounded-lg text-center">
                                        <img src="https://placehold.co/100x100/dbeafe/3b82f6?text=Expert" alt="Expert" class="mx-auto rounded-full">
                                        <h4 class="font-bold mt-4">Dr. Alice Carter</h4>
                                        <p class="text-sm text-blue-800 dark:text-blue-300">Plant Pathologist</p>
                                        <p class="text-xs mt-2">Struggling with a tough case? Get professional advice.</p>
                                        <a href="https://calendly.com/alicecarter/30min-consult" target="_blank" id="schedule-call-btn" class="mt-4 block w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 text-sm">Schedule Video Call</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="panel-market" class="module-panel hidden">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                             Marketplace & Price Tracker
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="font-semibold mb-2">Local Marketplace</h3>
                                    <div id="marketplace-list" class="space-y-3">
                                    <p id="marketplace-placeholder" class="text-center text-gray-500 dark:text-slate-400">Loading items...</p>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold mb-2">Live Crop Prices (Chennai, IN)</h3>
                                    <div id="price-tracker-list" class="overflow-x-auto">
                                        <p id="price-tracker-placeholder" class="text-center text-gray-500 dark:text-slate-400">Displaying simulated local prices...</p>
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW MODULE: Preventive Spray Schedule -->
                    <div id="panel-schedule" class="module-panel hidden">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 border-b dark:border-slate-600 pb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-4 18h4M3 9h18M5 13h14M7 17h10M7 21h10M7 3h10a2 2 0 012 2v14a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2z" /></svg>
                                Preventive Spray Schedule
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="font-semibold mb-2">Crop & Stage Input</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label for="schedule-crop" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Crop Type</label>
                                            <select id="schedule-crop" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg">
                                                <option value="Unknown">Select a crop...</option>
                                                <option value="Tomato">Tomato</option>
                                                <option value="Potato">Potato</option>
                                                <option value="Rice">Rice</option>
                                                <option value="Maize (Corn)">Maize (Corn)</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="schedule-stage" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Current Growth Stage</label>
                                            <select id="schedule-stage" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg">
                                                <option value="Vegetative">Vegetative</option>
                                                <option value="Flowering">Flowering</option>
                                                <option value="Fruiting/Grain">Fruiting/Grain</option>
                                                <option value="Harvest Prep">Harvest Prep</option>
                                            </select>
                                        </div>
                                        <button id="run-schedule-btn" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 font-semibold">Generate Schedule</button>
                                    </div>
                                </div>
                                <div class="bg-purple-50 dark:bg-slate-700 p-4 rounded-lg">
                                    <h3 class="font-semibold mb-2 text-purple-700 dark:text-purple-400">Predictive Risk Assessment</h3>
                                    <div id="schedule-result" class="text-sm space-y-2">
                                        <p class="text-center text-gray-500 dark:text-slate-400 mt-4">Set your crop type and stage to generate a proactive risk assessment based on long-term weather patterns and crop vulnerability.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END NEW MODULE -->
                </main>
            </div>
        </div>
        
        <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
                <div id="modal-icon" class="mx-auto mb-4 w-12 h-12 rounded-full flex items-center justify-center">
                    </div>
                <h3 id="modal-title" class="text-lg font-medium text-gray-900 dark:text-white"></h3>
                <p id="modal-message" class="text-sm text-gray-500 dark:text-slate-400 mt-2"></p>
                <button id="modal-close-btn" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg">Close</button>
            </div>
        </div>
        
        <!-- REMOVED: Treatment Modal HTML -->


        <script type="module">
            // Firebase Imports
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, serverTimestamp, getDocs, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            // --- *** NEW: IMPORT FIREBASE FUNCTIONS *** ---
            import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

            // --- Firebase Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyDo1LvE_2vH6nW7NZTBgYYCH5RRd2AMuiQ",
                authDomain: "cropguardai-project.firebaseapp.com",
                projectId: "cropguardai-project",
                storageBucket: "cropguardai-project.firebasestorage.app",
                messagingSenderId: "619122133800",
                appId: "1:619122133800:web:d160a5a0e4b79385c59e1d",
                measurementId: "G-K6YB5FKC53"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            // --- *** NEW: INITIALIZE FUNCTIONS & STUB *** ---
            const functions = getFunctions(app);
            const sendSms = httpsCallable(functions, 'sendSms'); // Connects to your backend function

            // --- DOM Elements ---
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginFormEl = document.getElementById('login-form');
            const registerFormEl = document.getElementById('register-form');
            const showRegisterLink = document.getElementById('show-register');
            const showLoginLink = document.getElementById('show-login');
            const logoutBtn = document.getElementById('logout-btn');
            const userGreeting = document.getElementById('user-greeting');
            const imageUpload = document.getElementById('crop-image-upload');
            const imagePreview = document.getElementById('image-preview');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const themeToggle = document.getElementById('theme-toggle');
            
            const resultPlaceholder = document.getElementById('result-placeholder');
            const resultContent = document.getElementById('result-content');
            const resultDetails = document.getElementById('result-details');
            const spinner = document.getElementById('spinner');
            const analysisStatus = document.getElementById('analysis-status');

            const diseaseName = document.getElementById('disease-name');
            const confidenceScore = document.getElementById('confidence-score');
            const severityWrapper = document.getElementById('severity-wrapper');
            const typeWrapper = document.getElementById('type-wrapper');
            const chemicalRec = document.getElementById('chemical-rec');
            const organicRec = document.getElementById('organic-rec');
            const preventionTitle = document.getElementById('prevention-title');
            const preventionTip = document.getElementById('prevention-tip');
            const severityLevel = document.getElementById('severity-level');
            const diseaseType = document.getElementById('disease-type');

            const weatherContent = document.getElementById('weather-content');
            const mapContent = document.getElementById('map-content');

            const alertMessage = document.getElementById('alert-message');
            const sendAlertBtn = document.getElementById('send-alert-btn');
            
            const notificationModal = document.getElementById('notification-modal');
            const modalIcon = document.getElementById('modal-icon');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            const historyList = document.getElementById('history-list');
            const historyPlaceholder = document.getElementById('history-placeholder');
            const historyDetailView = document.getElementById('history-detail-view');
            
            const moduleNav = document.getElementById('module-nav');
            const modulePanels = document.querySelectorAll('.module-panel');
            
            const outbreakAlertContainer = document.getElementById('outbreak-alert-container');
            const outbreakPlaceholder = document.getElementById('outbreak-placeholder');

            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');

            const marketplaceList = document.getElementById('marketplace-list');
            const marketplacePlaceholder = document.getElementById('marketplace-placeholder');
            const priceTrackerList = document.getElementById('price-tracker-list');
            const priceTrackerPlaceholder = document.getElementById('price-tracker-placeholder');

            // --- History Filter Elements ---
            const filterCrop = document.getElementById('filter-crop');
            const filterSeverity = document.getElementById('filter-severity');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            
            // --- New Schedule Elements ---
            const runScheduleBtn = document.getElementById('run-schedule-btn');
            const scheduleCrop = document.getElementById('schedule-crop');
            const scheduleStage = document.getElementById('schedule-stage');
            const scheduleResult = document.getElementById('schedule-result');


            // --- App State ---
            let currentUser = null;
            let historyUnsubscribe = null;
            let chatUnsubscribe = null;
            let currentHistoryData = []; // Store the full fetched history data
            let lastKnownLocation = { lat: null, lon: null }; // Stores location for Marketplace link

            // --- THEME LOGIC ---
            if (localStorage.getItem('theme') === 'dark') {
                themeToggle.checked = true;
            }
            themeToggle.addEventListener('change', () => {
                if (themeToggle.checked) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });

            // --- AUTHENTICATION LOGIC ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Try to fetch user profile, if not exists, create a stub (shouldn't happen with register flow, but for safety)
                    const userDocRef = doc(db, "users", user.uid);
                    let userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                         await setDoc(userDocRef, { name: 'New Farmer', email: user.email, phone: '+910000000000' });
                         userDoc = await getDoc(userDocRef);
                    }

                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    showDashboard();
                } else {
                    currentUser = null;
                    showAuth();
                }
            });

            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginFormEl.classList.add('hidden'); registerFormEl.classList.remove('hidden'); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerFormEl.classList.add('hidden'); loginFormEl.classList.remove('hidden'); });
            
            function validateEmail(email) {
             return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }
            function validatePhone(phone) {
             return /^\+91[6-9]\d{9}$/.test(phone);
            }
            function checkPasswordStrength(password) {
             let strength = 0;
             if (password.length >= 8) strength++;
             if (/[A-Z]/.test(password)) strength++;
             if (/[a-z]/.test(password)) strength++;
             if (/\d/.test(password)) strength++;
             if (/[!@#$%^&*]/.test(password)) strength++;
             if (strength <= 2) return 'Weak';
             if (strength === 3) return 'Medium';
             return 'Strong';
            }
            
            document.getElementById('register-password').addEventListener('input', function(e) {
             const password = e.target.value;
             const strength = checkPasswordStrength(password);
             const indicator = document.getElementById('password-strength');
             indicator.textContent = "Strength: " + strength;
             indicator.style.color = (
                 strength === 'Strong' ? 'green'
                 : strength === 'Medium' ? 'orange'
                 : 'red'
             );
            });

            document.getElementById('registerForm').addEventListener('submit', async function(e) {
             e.preventDefault();
             const name = document.getElementById('register-name').value.trim();
             const email = document.getElementById('register-email').value.trim();
             const phone = document.getElementById('register-phone').value.trim();
             const password = document.getElementById('register-password').value;
             const errorEl = document.getElementById('register-error');
            
             errorEl.classList.add('hidden'); 
             errorEl.textContent = '';

             if (!validateEmail(email)) {
                 errorEl.textContent = "Please enter a valid email address.";
                 errorEl.classList.remove('hidden');
                 return;
             }
             if (!validatePhone(phone)) {
                 errorEl.textContent = "Phone must be +91 followed by 10 digits starting from 6-9.";
                 errorEl.classList.remove('hidden');
                 return;
             }
             if (checkPasswordStrength(password) === 'Weak') {
                 errorEl.textContent = "Password is too weak. Use 8+ chars, cases, numbers, symbols.";
                 errorEl.classList.remove('hidden');
                 return;
             }
             
             try {
                 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                 const user = userCredential.user;
                 await setDoc(doc(db, "users", user.uid), {
                 name: name,
                 phone: phone,
                 email: email
                 });
                 errorEl.classList.add('hidden');
             } catch (error) {
                 if (error.code === 'auth/email-already-in-use') {
                     errorEl.textContent = "This email is already in use.";
                 } else {
                     errorEl.textContent = error.message;
                 }
                 errorEl.classList.remove('hidden');
             }
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorEl = document.getElementById('login-error');
                
                errorEl.classList.add('hidden'); 
                errorEl.textContent = ''; // Clear previous errors

                try {
                    // Attempt to sign in with email and password
                    await signInWithEmailAndPassword(auth, email, password);
                    // Auth state listener handles navigation to showDashboard on success
                } catch (error) {
                    // Sign-in failed
                    console.error("Login Error:", error.code, error.message);
                    
                    if (error.code === 'auth/invalid-email' || error.code === 'auth/user-not-found') {
                         errorEl.textContent = "Invalid email address or user not found.";
                    } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                         errorEl.textContent = "Invalid password for this account.";
                    } else if (error.code === 'auth/too-many-requests') {
                         errorEl.textContent = "Access temporarily blocked due to too many failed attempts.";
                    } else {
                         errorEl.textContent = "Login failed. Please check your details.";
                    }
                    errorEl.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', async () => { 
                if(historyUnsubscribe) historyUnsubscribe(); 
                if(chatUnsubscribe) chatUnsubscribe();
                await signOut(auth); 
            });

            function showDashboard() {
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userGreeting.textContent = `Hello, ${currentUser.name}!`;
                document.getElementById('alert-phone').value = currentUser.phone; 
                resetDashboard();
                listenForHistoryChanges();
                listenForChatMessages();
                fetchMarketplaceItems();
                fetchCommodityPrices();
            }

            function showAuth() {
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                document.getElementById('register-error').classList.add('hidden');
                document.getElementById('password-strength').textContent = '';
            }

            // --- MODULE NAVIGATION ---
            moduleNav.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    const targetPanelId = button.dataset.target;
                    moduleNav.querySelectorAll('button').forEach(btn => {
                        if (btn.dataset.target === targetPanelId) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    modulePanels.forEach(panel => {
                        if (panel.id === targetPanelId) {
                            panel.classList.remove('hidden');
                        } else {
                            panel.classList.add('hidden');
                        }
                    });
                }
            });

            // --- REAL-TIME API INTEGRATIONS ---
            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });

            const realDiseaseDetectionAPI = async (imageFile, cropType) => {
                // IMPORTANT: Replace the empty string below with your actual Google AI API Key.
                const apiKey = "AIzaSyDk1HybHkFJi0IecRgsK9bRm1MIhLe0dRg"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                // --- FIXED: Simplified Check ---
                if (!apiKey) {
                    console.error("API Key Missing: Please provide a valid Gemini API Key.");
                    return { success: false, data: { analysis: { disease: 'Configuration Error', confidence: 'N/A', severity: 'N/A', type: 'N/A' }, treatment: { chemical: 'Please insert your Google AI API key in the script.', organic: '', prevention: '' } } };
                }
                // --- END FIXED CHECK ---

                try {
                    const base64ImageData = await fileToBase64(imageFile);
                    const prompt = `You are an expert agricultural scientist. Analyze this image of a ${cropType} plant. 
                    Respond ONLY with a single, minified JSON object with no markdown.
                    The JSON format must be:
                    {
                      "analysis": {
                        "disease": "Name of disease or 'Healthy'",
                        "type": "Fungal / Bacterial / Viral / Pest / Deficiency / Unknown",
                        "severity": "Low / Medium / High / Not Applicable",
                        "confidence": "e.g., '95.5%'"
                      },
                      "treatment": {
                        "chemical": "A specific chemical treatment recommendation (product or ingredient) and application instructions.",
                        "organic": "A specific organic-safe treatment recommendation (method or product) and application instructions.",
                        "prevention": "A short tip on how to prevent this in the future."
                      }
                    }`;

                    const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: imageFile.type, data: base64ImageData } }] }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!response.ok) { 
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`API call failed with status: ${response.status}`); 
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        let jsonResponseText = candidate.content.parts[0].text;
                        if (jsonResponseText.startsWith('```json')) {
                            jsonResponseText = jsonResponseText.substring(7, jsonResponseText.length - 3).trim();
                        } else if (jsonResponseText.startsWith('```')) {
                            jsonResponseText = jsonResponseText.substring(3, jsonResponseText.length - 3).trim();
                        }
                        const parsedJson = JSON.parse(jsonResponseText);
                        return { success: true, data: parsedJson };
                    } else { 
                        throw new Error("Invalid response structure from AI model."); 
                    }
                } catch (error) {
                    console.error("Disease Detection API Error:", error);
                    return { success: false, data: { analysis: { disease: 'API Error', confidence: 'N/A', severity: 'N/A', type: 'N/A' }, treatment: { chemical: 'Could not connect to the analysis service.', organic: '', prevention: '' } } };
                }
            };
            
            const getAITextAnalysis = async (prompt) => {
                // IMPORTANT: Replace the empty string below with your actual Google AI API Key.
                const apiKey = "AIzaSyDk1HybHkFJi0IecRgsK9bRm1MIhLe0dRg"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                // --- FIXED: Simplified Check ---
                if (!apiKey) {
                    console.warn("API Key Missing for Text Analysis.");
                    return "AI analysis unavailable due to missing API key.";
                }
                // --- END FIXED CHECK ---

                try {
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        console.error("AI Text API Error Response:", await response.text());
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        throw new Error("Invalid text response from AI model.");
                    }
                } catch (error) {
                    console.error("AI Text Analysis Error:", error);
                    return "Could not get AI analysis at this time.";
                }
            };

            const getWeatherData = async (lat, lon) => {
                const apiKey = "957307f041714831127cef2bb58ae67e"; // Replace with your OpenWeatherMap key
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to fetch weather data');
                    }
                    const data = await response.json();
                    return { temp: `${data.main.temp}°C`, humidity: `${data.main.humidity}%`, condition: data.weather[0].main, };
                } catch (error) {
                    console.error("Weather API Error:", error);
                    return { error: `Weather service error: ${error.message}` };
                }
            };

            const getMapData = (lat, lon) => ({ latitude: lat.toFixed(4), longitude: lon.toFixed(4), mapUrl: `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lon}` });

            const sendNotificationRequest = async (phone, message) => {
                console.log(`Attempting to send real SMS to: ${phone}`);
                try {
                    // Call the Firebase Cloud Function
                    const result = await sendSms({ phone: phone, message: message });
                    
                    // The function was successful
                    console.log("Cloud Function succeeded:", result.data);
                    return { success: true, messageId: result.data.messageId };

                } catch (error) {
                    console.error("Cloud Function error:", error);
                    
                    // Update the modal to show the specific error
                    modalTitle.textContent = 'SMS Failed';
                    modalMessage.textContent = error.message; // Show the real error
                    showModal('error', false); // Show the error modal

                    // Return a failure object
                    return { success: false };
                }
            };
            
            // --- NEW API INTEGRATION: Simulated Historical Risk Service ---
            // This function simulates fetching historical/long-term risk data based on location and crop.
            // This represents the 4th distinct API used in the project.
            const getPredictiveRisk = async (crop, stage, lat, lon) => {
                console.log(`Querying Historical Risk API for ${crop} at ${stage}.`);
                
                // Simulate varying results based on input
                if (crop === 'Tomato' && stage === 'Flowering') {
                    return {
                        riskLevel: 'HIGH',
                        diseases: 'Late Blight, Powdery Mildew',
                        recommendation: 'Immediate preventative fungicide application is critical, as historical data shows high fungal activity during this stage with current location humidity levels.',
                        riskFactors: ['High historical humidity variance', 'Crop susceptibility at flowering stage']
                    };
                }
                
                if (crop === 'Rice' && stage === 'Vegetative') {
                     return {
                        riskLevel: 'LOW',
                        diseases: 'None expected',
                        recommendation: 'Maintain standard monitoring. Risk is low based on typical weather cycles.',
                        riskFactors: ['Stable recent temperature/rainfall profile']
                    };
                }

                return {
                    riskLevel: 'MEDIUM',
                    diseases: 'General fungal risk',
                    recommendation: 'Monitor weather forecasts for humidity spikes and plan for preventative spraying within the next 7 days.',
                    riskFactors: ['General regional risk factors']
                };
            };
            // --- END NEW API INTEGRATION ---

            // --- APPLICATION LOGIC ---
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreview.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
                runAnalysis(file);
            });

            async function runAnalysis(file) {
                resetAnalysisUI();
                resultPlaceholder.classList.add('hidden');
                resultContent.classList.remove('hidden');
                spinner.classList.remove('hidden');
                analysisStatus.classList.remove('hidden');
                resultDetails.classList.add('hidden');

                const cropType = document.getElementById('crop-type').value;
                if (cropType === "Unknown") {
                     analysisStatus.textContent = 'Please select a crop type first.';
                     analysisStatus.classList.remove('hidden');
                     spinner.classList.add('hidden');
                     return;
                }
                analysisStatus.textContent = `Analyzing ${cropType} image...`;

                const detectionResponse = await realDiseaseDetectionAPI(file, cropType);
                
                spinner.classList.add('hidden');
                resultDetails.classList.remove('hidden');

                if (detectionResponse.success) {
                    const { analysis, treatment } = detectionResponse.data;
                    let msg = ""; 

                    if (analysis.disease.toLowerCase() === 'healthy') {
                        diseaseName.textContent = "Your crop appears Healthy!";
                        diseaseName.classList.add('text-green-600', 'dark:text-green-500'); 
                        confidenceScore.textContent = analysis.confidence;
                        severityWrapper.style.display = 'none';
                        typeWrapper.style.display = 'none';
                        chemicalRec.closest('div').style.display = 'none';
                        organicRec.closest('div').style.display = 'none';
                        preventionTitle.textContent = "Proactive Tips";
                        preventionTip.textContent = treatment.prevention || "Keep up the great work! Continue to monitor your crops regularly.";
                        msg = `CropGuard Alert: Your ${cropType} appears Healthy (${analysis.confidence}). Keep monitoring!`;
                    } else {
                        diseaseName.classList.remove('text-green-600', 'dark:text-green-500');
                        severityWrapper.style.display = 'block';
                        typeWrapper.style.display = 'block';
                        chemicalRec.closest('div').style.display = 'block';
                        organicRec.closest('div').style.display = 'block';
                        preventionTitle.textContent = "Prevention Tip";
                        diseaseName.textContent = analysis.disease;
                        confidenceScore.textContent = analysis.confidence;
                        diseaseType.textContent = analysis.type;
                        severityLevel.textContent = analysis.severity;
                        
                        severityLevel.classList.remove('bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800', 'dark:bg-green-900', 'dark:text-green-300', 'dark:bg-yellow-900', 'dark:text-yellow-300', 'dark:bg-red-900', 'dark:text-red-300');
                        if (analysis.severity === 'Low') {
                            severityLevel.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-300');
                        } else if (analysis.severity === 'Medium') {
                            severityLevel.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900', 'dark:text-yellow-300');
                        } else if (analysis.severity === 'High') {
                            severityLevel.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-300');
                        }

                        chemicalRec.textContent = treatment.chemical;
                        organicRec.textContent = treatment.organic;
                        preventionTip.textContent = treatment.prevention;
                        msg = `CropGuard Alert: Detected ${analysis.disease} (Severity: ${analysis.severity}, Type: ${analysis.type}). Chemical: ${treatment.chemical}. Organic: ${treatment.organic}.`;
                    }

                    alertMessage.value = msg;
                    sendAlertBtn.disabled = false;

                    // --- NEW: Detection Confirmation Modal ---
                    let modalType = analysis.disease.toLowerCase() === 'healthy' ? 'success' : 'warning';
                    let modalMsg = `Crop: ${cropType}. Status: **${analysis.disease}** (${analysis.confidence}). Severity: **${analysis.severity}**. Check Context for environmental risk.`;
                    
                    showModal(modalType, true, 'Analysis Complete', modalMsg);
                    // --- END NEW: Detection Confirmation Modal ---

                    try {
                        const docRef = await addDoc(collection(db, `users/${currentUser.uid}/detections`), {
                            ...analysis,
                            ...treatment,
                            cropType: cropType,
                            timestamp: serverTimestamp() // Use serverTimestamp for Firestore consistency
                        });
                        console.log("Document written with ID: ", docRef.id);
                    } catch (e) { console.error("Error adding document: ", e); }

                    // --- LOCATION AND WEATHER ---
                    analysisStatus.textContent = 'Fetching location and weather data...';
                    if ('geolocation' in navigator) {
                        navigator.geolocation.getCurrentPosition(async (position) => {
                            const { latitude, longitude } = position.coords;
                            // Store location for marketplace link
                            lastKnownLocation = { lat: latitude, lon: longitude }; 
                            
                            const weather = await getWeatherData(latitude, longitude);

                            const weatherBasicsEl = document.getElementById('weather-basics');
                            const weatherPlaceholder = document.getElementById('weather-placeholder');
                            const currentWeatherDetails = document.getElementById('current-weather-details');
                            const weatherRiskAssessment = document.getElementById('weather-risk-assessment');
                            const riskSpinner = document.getElementById('risk-spinner');
                            const riskText = document.getElementById('risk-assessment-text');
                            
                            weatherPlaceholder.classList.add('hidden');
                            currentWeatherDetails.classList.remove('hidden');
                            weatherRiskAssessment.classList.remove('hidden');
                            riskSpinner.classList.remove('hidden');
                            riskText.classList.add('hidden');

                            weatherBasicsEl.innerHTML = weather.error 
                                ? `<p class="text-red-500">${weather.error}.</p>` 
                                : `<p><strong>Temperature:</strong> ${weather.temp}</p><p><strong>Humidity:</strong> ${weather.humidity}</p><p><strong>Condition:</strong> ${weather.condition}</p>`;

                            const location = getMapData(latitude, longitude);
                            mapContent.innerHTML = `<p class="text-sm"><strong>Lat:</strong> ${location.latitude}, <strong>Lon:</strong> ${location.longitude}</p><iframe class="w-full h-40 rounded-lg mt-2 border dark:border-slate-600" loading="lazy" src="${location.mapUrl}"></iframe>`;
                            
                            const { analysis } = detectionResponse.data;
                            const diseaseForContext = analysis.disease;
                            
                            if (!weather.error && diseaseForContext.toLowerCase() !== 'healthy') {
                                const riskPrompt = `My crop is ${cropType}. I just detected ${diseaseForContext}. 
                                The current weather is: ${weather.temp}, ${weather.humidity} humidity, and ${weather.condition}.
                                In 2-3 short sentences, what is the immediate risk for this disease spreading and what is one urgent, weather-related action I should take?`;
                                
                                getAITextAnalysis(riskPrompt).then(riskAnalysisText => {
                                    riskText.textContent = riskAnalysisText;
                                    riskSpinner.classList.add('hidden');
                                    riskText.classList.remove('hidden');
                                });

                            } else if (diseaseForContext.toLowerCase() === 'healthy') {
                                riskText.textContent = "Weather conditions look good. Since your crop is healthy, just continue standard monitoring.";
                                riskSpinner.classList.add('hidden');
                                riskText.classList.remove('hidden');
                            } else {
                                riskText.textContent = "Could not generate risk analysis due to weather data error.";
                                riskSpinner.classList.add('hidden');
                                riskText.classList.remove('hidden');
                            }

                            analysisStatus.classList.add('hidden');
                        }, 
                        () => {
                            weatherContent.innerHTML = `<p class="text-red-500">Geolocation permission denied.</p>`;
                            mapContent.innerHTML = `<p class="text-red-500">Geolocation permission denied.</p>`;
                            analysisStatus.classList.add('hidden');
                            lastKnownLocation = { lat: null, lon: null };
                        });
                    } else {
                        weatherContent.innerHTML = `<p class="text-red-500">Geolocation not supported.</p>`;
                        analysisStatus.classList.add('hidden');
                        lastKnownLocation = { lat: null, lon: null };
                    }
                } else {
                    const { analysis, treatment } = detectionResponse.data;
                    diseaseName.textContent = analysis.disease;
                    confidenceScore.textContent = analysis.confidence;
                    chemicalRec.textContent = treatment.chemical;
                    analysisStatus.classList.add('hidden');
                }
            }
            
            // --- MODIFIED: showModal function to accept title and message ---
            const showModal = (type, isSuccess, customTitle = null, customMessage = null) => {
                notificationModal.classList.remove('hidden');
                
                if (isSuccess) {
                    modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                    modalIcon.className = `mx-auto mb-4 w-12 h-12 rounded-full flex items-center justify-center ${type === 'warning' ? 'bg-orange-500' : 'bg-green-500'}`;
                    modalTitle.textContent = customTitle || (type === 'alert' ? 'Alert Sent!' : 'Success!');
                    modalMessage.innerHTML = customMessage || (type === 'alert' ? 'The SMS alert has been successfully queued for delivery.' : 'Operation completed successfully.');
                } else {
                    modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
                    modalIcon.className = 'mx-auto mb-4 w-12 h-12 rounded-full flex items-center justify-center bg-red-500';
                    modalTitle.textContent = customTitle || 'Failed';
                    modalMessage.innerHTML = customMessage || 'There was a problem with your request.';
                }
            };
            // --- END MODIFIED showModal ---

            // --- UPDATED: ALERT BUTTON LISTENER ---
            sendAlertBtn.addEventListener('click', async () => {
                const phoneInput = document.getElementById('alert-phone');
                const phone = phoneInput.value.trim();
                const message = alertMessage.value;

                if (!validatePhone(phone)) {
                    showModal('error', false, 'Invalid Phone Number', 'Please enter a valid phone number in the format +91XXXXXXXXXX.');
                    return;
                }

                sendAlertBtn.disabled = true;
                sendAlertBtn.textContent = "Sending...";
                
                const response = await sendNotificationRequest(phone, message);
                
                if (response.success) {
                    showModal('alert', true); // Only show success
                }
                
                sendAlertBtn.textContent = "Send SMS Alert";
            });
            
            modalCloseBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));

            // --- HISTORY, OUTBREAK, COMMUNITY, MARKET LOGIC ---
            
            // Central function to fetch ALL detections and treatments
            function listenForHistoryChanges() {
                if (historyUnsubscribe) historyUnsubscribe();
                // We order by timestamp descending in the query to avoid needing client-side sorting later
                const q = query(collection(db, `users/${currentUser.uid}/detections`), orderBy("timestamp", "desc"));
                
                historyUnsubscribe = onSnapshot(q, async (snapshot) => {
                    const historyPromises = snapshot.docs.map(async (doc) => {
                        const detection = { id: doc.id, ...doc.data() };
                        
                        // Fetch treatments subcollection for this detection.
                        const treatmentsCol = collection(db, `users/${currentUser.uid}/detections/${doc.id}/treatments`);
                        const treatmentsQuery = query(treatmentsCol, orderBy("dateApplied", "desc"));

                        let treatmentsSnapshot;
                        try {
                            // Since we are removing log functionality, we keep the data fetch for displaying old logs,
                            // but remove the logic to save new ones.
                            treatmentsSnapshot = await getDocs(treatmentsQuery);
                        } catch (e) {
                            console.error(`Error fetching treatments for detection ${doc.id}:`, e);
                            detection.treatments = [];
                            if(detection.timestamp && detection.timestamp.toDate) {
                                detection.displayDate = detection.timestamp.toDate().toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                            } else {
                                detection.displayDate = 'N/A';
                            }
                            return detection; 
                        }
                        
                        // Ensure dateApplied is converted correctly from Firestore Timestamp
                        detection.treatments = treatmentsSnapshot.docs.map(treatDoc => {
                            const data = treatDoc.data();
                            const dateApplied = data.dateApplied && data.dateApplied.toDate
                                ? data.dateApplied.toDate().toLocaleDateString()
                                : 'N/A'; // Handle case where data might be missing or not a Timestamp
                            
                            return {
                                id: treatDoc.id, 
                                ...data,
                                dateApplied: dateApplied
                            };
                        });
                        
                        // Format the main timestamp once for UI use
                        detection.displayDate = detection.timestamp.toDate().toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                        return detection;
                    });

                    // Use Promise.allSettled to ensure the whole process doesn't fail if one sub-query fails
                    const results = await Promise.allSettled(historyPromises);
                    currentHistoryData = results
                        .filter(result => result.status === 'fulfilled')
                        .map(result => result.value);
                    
                    // Trigger rendering and outbreak analysis with the filtered successful data
                    applyFiltersAndRender();
                    analyzeUserHistoryForOutbreaks(currentHistoryData);
                    // Rerun market item fetch to ensure recommendations are based on new data
                    fetchMarketplaceItems();
                }, (error) => {
                    console.error("Error listening to history changes:", error);
                    historyPlaceholder.textContent = "Error loading history.";
                });
            }

            // Function to apply filters to the fetched data and trigger UI render
            function applyFiltersAndRender() {
                const cropFilter = filterCrop.value;
                const severityFilter = filterSeverity.value;

                let filteredHistory = currentHistoryData;

                // 1. Filter by Crop Type
                if (cropFilter !== 'All') {
                    filteredHistory = filteredHistory.filter(item => item.cropType === cropFilter);
                }

                // 2. Filter by Severity
                if (severityFilter !== 'All') {
                    filteredHistory = filteredHistory.filter(item => item.severity === severityFilter);
                }

                renderHistoryList(filteredHistory);
            }

            // Event listeners for filters
            filterCrop.addEventListener('change', applyFiltersAndRender);
            filterSeverity.addEventListener('change', applyFiltersAndRender);
            clearFiltersBtn.addEventListener('click', () => {
                filterCrop.value = 'All';
                filterSeverity.value = 'All';
                applyFiltersAndRender();
            });

            // Renders the left-hand list of filtered history items
            function renderHistoryList(history) {
                historyDetailView.innerHTML = '<p class="text-center text-gray-500 dark:text-slate-400 mt-12">Select an entry from the left to view full details and logs.</p>';

                if (!history || history.length === 0) {
                    historyPlaceholder.classList.remove('hidden');
                    historyPlaceholder.textContent = 'No detections match your filter criteria.';
                    historyList.innerHTML = '';
                    return;
                } 
                
                historyPlaceholder.classList.add('hidden');
                historyList.innerHTML = history.map(item => {
                    const disease = item.disease || 'N/A';
                    const crop = item.cropType || 'Unknown Crop';
                    const severity = item.severity || 'N/A';
                    const isHealthy = disease.toLowerCase() === 'healthy';
                    const statusClass = isHealthy ? 'text-green-500' : (severity === 'High' ? 'text-red-500' : 'text-yellow-500');

                    return `
                        <div data-detection-id="${item.id}" class="history-item cursor-pointer bg-gray-50 dark:bg-slate-700/50 p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
                            <p class="font-semibold ${statusClass}">${crop}: ${disease}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500 dark:text-slate-400">
                                <span>Severity: ${severity}</span>
                                <span>${item.displayDate}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Event listener for selecting a history item
            historyList.addEventListener('click', (e) => {
                const itemEl = e.target.closest('.history-item');
                if (itemEl) {
                    const detectionId = itemEl.dataset.detectionId;
                    const selectedItem = currentHistoryData.find(item => item.id === detectionId);
                    if (selectedItem) {
                        // Logic to set hidden fields for treatment logging (REMOVED)
                        renderHistoryDetail(selectedItem);
                    }
                }
            });

            // Renders the detailed view in the right column
            function renderHistoryDetail(item) {
                const isHealthy = item.disease.toLowerCase() === 'healthy';

                const severityClass = item.severity === 'Low' ? 'bg-green-500' : (item.severity === 'Medium' ? 'bg-yellow-500' : 'bg-red-500');

                const detailHtml = `
                    <div class="space-y-4">
                        <div class="flex justify-between items-start border-b dark:border-slate-600 pb-3">
                            <div>
                                <h4 class="text-xl font-bold">${item.cropType}: ${item.disease}</h4>
                                <p class="text-sm text-gray-500 dark:text-slate-400">Detected on: ${item.displayDate}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold text-white px-3 py-1 rounded-full ${severityClass}">Severity: ${item.severity}</span>
                                <p class="text-sm mt-1">Confidence: ${item.confidence}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Disease Type:</strong> ${item.type}</div>
                            <div><strong>Recommended Chemical:</strong> ${item.chemical}</div>
                            <div><strong>Recommended Organic:</strong> ${item.organic}</div>
                            <div><strong>Prevention Tip:</strong> ${item.prevention}</div>
                        </div>
                        
                        <div class="border-t dark:border-slate-600 pt-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-bold text-base">Treatment Logs (${item.treatments.length})</h5>
                                <!-- Log Treatment Button REMOVED -->
                            </div>
                            <div id="treatment-log-list" class="space-y-3 max-h-40 overflow-y-auto pr-1">
                                ${item.treatments && item.treatments.length > 0
                                    ? item.treatments.map(t => `
                                        <div class="bg-white dark:bg-slate-800 p-3 rounded-md text-xs flex justify-between items-center">
                                            <div>
                                                <p class="font-bold">${t.name}</p>
                                                <p class="text-gray-600 dark:text-slate-400">Applied: ${t.dateApplied}</p>
                                                ${t.notes ? `<p class="text-gray-500 dark:text-slate-500 mt-1">Notes: ${t.notes}</p>` : ''}
                                            </div>
                                            <!-- Delete Treatment Button REMOVED -->
                                        </div>
                                    `).join('')
                                    : `<p class="text-sm text-gray-500 dark:text-slate-400">No treatments logged for this detection yet.</p>`
                                }
                            </div>
                        </div>
                    </div>
                `;
                historyDetailView.innerHTML = detailHtml;
            }

            // Event listener for opening the log treatment modal (REMOVED LOGIC)
            historyDetailView.addEventListener('click', (e) => {
                // All code that checked for .add-treatment-btn and .delete-treatment-btn REMOVED
            });

            // REMOVED: deleteTreatmentLog function
            // REMOVED: treatmentCancelBtn listener
            // REMOVED: treatmentForm submit listener

            function analyzeUserHistoryForOutbreaks(history) {
                // --- MODIFIED: Stricter Recurrence Check (last 30 days) ---
                const oneMonthAgo = new Date();
                oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);

                const diseaseCounts = history.reduce((acc, item) => {
                    // Check if timestamp exists and is within the last 30 days
                    if (item.timestamp && item.timestamp.toDate() > oneMonthAgo) {
                        const disease = item.disease || 'Unknown';
                        if (disease.toLowerCase() !== 'healthy' && disease !== 'Unknown') {
                            acc[disease] = (acc[disease] || 0) + 1;
                        }
                    }
                    return acc;
                }, {});

                const alerts = [];
                for (const disease in diseaseCounts) {
                    // Alert if the same disease occurs 3 or more times in the last 30 days
                    if (diseaseCounts[disease] >= 3) {
                        alerts.push({ disease, count: diseaseCounts[disease] });
                    }
                }
                // --- END MODIFIED ---

                if (alerts.length > 0) {
                    outbreakPlaceholder.classList.add('hidden');
                    outbreakAlertContainer.innerHTML = alerts.map(alert => `
                        <div class="bg-red-100 dark:bg-red-900/50 border-l-4 border-red-500 p-4 rounded-r-lg">
                            <h4 class="font-bold">High Personal Risk: Recurring ${alert.disease}</h4>
                            <p class="text-sm mt-1">We have detected this disease **${alert.count} times in the last 30 days**. This indicates a localized outbreak. Consult an expert and apply widespread preventative treatment.</p>
                        </div>
                    `).join('');
                } else {
                    outbreakPlaceholder.classList.remove('hidden');
                    outbreakAlertContainer.innerHTML = '';
                    outbreakPlaceholder.textContent = 'No significant recurring threats detected in the last 30 days.';
                }
            }
            
            function listenForChatMessages() {
                if (chatUnsubscribe) chatUnsubscribe();
                const q = query(collection(db, `artifacts/${appId}/public/data/community-chat`), orderBy("timestamp", "asc"));
                
                try {
                    chatUnsubscribe = onSnapshot(q, (snapshot) => {
                        const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderChatMessages(messages);
                    }, (error) => {
                        // Log the error but don't stop execution
                        console.error("Error listening to chat messages:", error);
                        chatMessages.innerHTML = `<p class="text-center text-sm text-red-500 dark:text-red-400">Could not load chat messages due to insufficient permissions or network error.</p>`;
                    });
                } catch (error) {
                    console.error("Error setting up chat listener:", error);
                    chatMessages.innerHTML = `<p class="text-center text-sm text-red-500 dark:text-red-400">Could not initialize chat service due to missing permissions.</p>`;
                }
            }

            function renderChatMessages(messages) {
                if (!messages || messages.length === 0) {
                    chatMessages.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-slate-400">No messages yet. Start the conversation!</p>`;
                    return;
                }
                chatMessages.innerHTML = messages.map(msg => {
                    const isCurrentUser = msg.userId === currentUser.uid;
                    const alignment = isCurrentUser ? 'flex-row-reverse' : '';
                    const bubbleColor = isCurrentUser ? 'bg-green-100 dark:bg-green-800' : 'bg-white dark:bg-slate-600';
                    const nameColor = isCurrentUser ? 'text-green-700 dark:text-green-400' : 'text-blue-700 dark:text-blue-400';

                    return `
                        <div class="flex gap-2 ${alignment}">
                            <div class="${bubbleColor} p-2 rounded-lg max-w-xs">
                                <p class="font-bold text-xs ${nameColor}">${isCurrentUser ? 'You' : msg.userName} - ID: ${msg.userId.substring(0, 5)}...</p>
                                <p class="text-sm">${msg.text}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageText = chatInput.value.trim();
                if (messageText) {
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/community-chat`), {
                            text: messageText,
                            userName: currentUser.name,
                            userId: currentUser.uid,
                            timestamp: serverTimestamp()
                        });
                        chatInput.value = '';
                    } catch (error) {
                        console.error("Error sending message:", error);
                        showModal('error', false);
                        modalTitle.textContent = 'Chat Failed';
                        modalMessage.textContent = 'Could not send message due to permission error.';
                    }
                }
            });
            
            async function fetchMarketplaceItems() {
                const marketplaceCol = collection(db, `artifacts/${appId}/public/data/marketplace`);
                
                try {
                    const snapshot = await getDocs(marketplaceCol);
                    
                    if (snapshot.empty) {
                        // Attempt to seed data if empty, handling potential permission errors on write
                        try {
                            await addDoc(marketplaceCol, { name: 'BioSafe Fungicide', description: 'Effective against mildew', recommendationScore: 0.8 });
                            await addDoc(marketplaceCol, { name: 'Organic Nutrient Mix', description: 'Promotes leaf health', recommendationScore: 0.5 });
                            // After seeding, recall to fetch and render
                            fetchMarketplaceItems();
                        } catch (e) {
                            console.warn("Could not seed marketplace data (likely permission issue).");
                             renderMarketplaceItems(null, "Marketplace items could not be loaded due to security permission errors.");
                        }
                        return;
                    }
                    
                    let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), recommendationScore: doc.data().recommendationScore || 0 }));
                    
                    // --- Dynamic Sorting based on last detection ---
                    if (currentHistoryData.length > 0) {
                        const lastDetection = currentHistoryData[0];
                        
                        // Simple logic: boost items related to fungicide if the latest disease is fungal or severe
                        const needsFungicide = lastDetection.type === 'Fungal' || lastDetection.severity === 'High';
                        
                        if (needsFungicide) {
                            items = items.map(item => {
                                if (item.name.toLowerCase().includes('fungicide') || item.name.toLowerCase().includes('chemical')) {
                                    item.recommendationScore = Math.min(1.0, item.recommendationScore + 0.3); // Boost score
                                }
                                return item;
                            });
                        }
                        
                        // Sort by the boosted recommendation score (highest first)
                        items.sort((a, b) => b.recommendationScore - a.recommendationScore);
                    }
                    // --- END Dynamic Sorting ---
                    
                    renderMarketplaceItems(items);
                } catch (error) {
                    console.error("Error fetching marketplace items:", error);
                    // Render error state on the UI
                    renderMarketplaceItems(null, "Marketplace items could not be loaded due to security permission errors.");
                }
            }

            function renderMarketplaceItems(items, errorMessage = null) {
                if (errorMessage) {
                    marketplacePlaceholder.classList.remove('hidden');
                    marketplacePlaceholder.textContent = errorMessage;
                    marketplaceList.innerHTML = '';
                    return;
                }
                
                if (!items || items.length === 0) {
                    marketplacePlaceholder.textContent = 'No items found in the marketplace.';
                } else {
                    marketplacePlaceholder.classList.add('hidden');
                    
                    // Get location from stored state, defaulting to generic if not found
                    const supplierQuery = (lastKnownLocation.lat && lastKnownLocation.lon)
                        ? `agricultural+suppliers+near+${lastKnownLocation.lat},+${lastKnownLocation.lon}`
                        : 'agricultural+suppliers+near+me';
                    
                    const supplierUrl = `https://www.google.com/maps/search/?api=1&query=${supplierQuery}`;

                    marketplaceList.innerHTML = items.map(item => {
                        const recScore = item.recommendationScore || 0;
                        const recText = recScore >= 0.9 ? 'Highly Recommended' : (recScore >= 0.7 ? 'Recommended' : 'Standard');
                        const recClass = recScore >= 0.9 ? 'text-green-600 dark:text-green-400 font-bold' : (recScore >= 0.7 ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-500');

                        return `
                            <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg flex items-center justify-between">
                                <div>
                                    <p class="font-bold">${item.name}</p>
                                    <p class="text-sm text-gray-500 dark:text-slate-400">${item.description}</p>
                                    <p class="text-xs mt-1 ${recClass}">AI Rating: ${recText}</p>
                                </div>
                                <a href="${supplierUrl}" target="_blank" class="find-supplier-btn text-sm bg-gray-200 dark:bg-slate-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-slate-500">Find Suppliers</a>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            function fetchCommodityPrices() {
                const simulatedData = [
                    { name: 'Tomato (Koyambedu)', price: 45.50, change: 2.5, volatility: 'Low' },
                    { name: 'Onion (Koyambedu)', price: 32.00, change: -1.5, volatility: 'Medium' },
                    { name: 'Potato (Koyambedu)', price: 28.75, change: 0.5, volatility: 'High' }
                ];

                priceTrackerPlaceholder.classList.add('hidden');
                const tableHtml = `
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 dark:bg-slate-700">
                            <tr>
                                <th class="p-2 rounded-l-lg">Crop</th>
                                <th>Price/kg (INR)</th>
                                <th>Trend</th>
                                <th class="rounded-r-lg">Volatility</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${simulatedData.map(item => {
                                const trendIcon = item.change > 0 
                                            ? '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>' 
                                            : '<svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>';
                                
                                const volatilityClass = item.volatility === 'High' ? 'text-red-500' : (item.volatility === 'Medium' ? 'text-yellow-500' : 'text-green-500');

                                return `
                                <tr class="border-b dark:border-slate-700">
                                    <td class="p-2 font-medium">${item.name}</td>
                                    <td>₹${item.price.toFixed(2)}</td>
                                    <td>${trendIcon}</td>
                                    <td class="${volatilityClass}">${item.volatility}</td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                priceTrackerList.innerHTML = tableHtml;
            }
            
            function resetAnalysisUI() {
                // Reset Detection Panel
                resultPlaceholder.classList.remove('hidden');
                resultContent.classList.add('hidden');
                diseaseName.textContent = '';
                confidenceScore.textContent = '';
                severityLevel.textContent = '';
                diseaseType.textContent = '';
                chemicalRec.textContent = '';
                organicRec.textContent = '';
                preventionTip.textContent = '';
                diseaseName.classList.remove('text-green-600', 'dark:text-green-500');
                severityWrapper.style.display = 'block';
                typeWrapper.style.display = 'block';
                chemicalRec.closest('div').style.display = 'block';
                organicRec.closest('div').style.display = 'block';
                preventionTitle.textContent = "Prevention Tip";

                // Reset Context Panel
                document.getElementById('weather-placeholder').classList.remove('hidden');
                document.getElementById('current-weather-details').classList.add('hidden');
                document.getElementById('weather-risk-assessment').classList.add('hidden');
                document.getElementById('weather-basics').innerHTML = '';
                document.getElementById('risk-assessment-text').textContent = '';
                document.getElementById('map-content').innerHTML = 'Awaiting detection...';
                
                // Reset Alert Panel
                alertMessage.value = '';
                sendAlertBtn.disabled = true;
                if (currentUser) {
                    document.getElementById('alert-phone').value = currentUser.phone;
                }
            }

            function resetDashboard() {
                resetAnalysisUI();
                renderHistoryList([]); // Clear the history list UI
                historyDetailView.innerHTML = '<p class="text-center text-gray-500 dark:text-slate-400 mt-12">Select an entry from the left to view full details and logs.</p>';
                imagePreview.classList.add('hidden');
                uploadPlaceholder.classList.remove('hidden');
                imageUpload.value = '';
                document.getElementById('crop-type').value = 'Unknown';
                filterCrop.value = 'All';
                filterSeverity.value = 'All';
                moduleNav.querySelector('button[data-target="panel-detection"]').click();
            }
            
            // --- NEW SCHEDULE LOGIC ---
            runScheduleBtn.addEventListener('click', () => {
                const crop = scheduleCrop.value;
                const stage = scheduleStage.value;
                
                if (crop === 'Unknown') {
                    scheduleResult.innerHTML = `<p class="text-red-500">Please select a crop type first.</p>`;
                    return;
                }

                // Use the last known location for the predictive model
                const { lat, lon } = lastKnownLocation;

                if (!lat || !lon) {
                    scheduleResult.innerHTML = `<p class="text-orange-500">Location not determined. Please run a detection first to get your coordinates.</p>`;
                    return;
                }

                scheduleResult.innerHTML = `
                    <div class="flex justify-center items-center gap-3">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-purple-500"></div>
                        <p class="text-purple-500">Analyzing long-term data...</p>
                    </div>
                `;

                getPredictiveRisk(crop, stage, lat, lon).then(result => {
                    const riskClass = result.riskLevel === 'HIGH' ? 'bg-red-500' : (result.riskLevel === 'MEDIUM' ? 'bg-yellow-500' : 'bg-green-500');
                    const riskTextClass = result.riskLevel === 'HIGH' ? 'text-red-600 dark:text-red-400' : (result.riskLevel === 'MEDIUM' ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400');

                    scheduleResult.innerHTML = `
                        <div class="p-3 rounded-lg border dark:border-slate-600 space-y-3">
                            <p class="font-bold text-lg flex justify-between items-center">
                                Predicted Risk: 
                                <span class="text-white text-xs font-semibold px-3 py-1 rounded-full ${riskClass}">
                                    ${result.riskLevel}
                                </span>
                            </p>
                            <p><strong>Primary Concern:</strong> <span class="${riskTextClass}">${result.diseases}</span></p>
                            <p><strong>Actionable Advice:</strong> ${result.recommendation}</p>
                            <p class="text-xs text-gray-500 dark:text-slate-400">
                                *Factors considered: ${result.riskFactors.join(', ')}.
                            </p>
                        </div>
                    `;
                });
            });
            // --- END NEW SCHEDULE LOGIC ---
        </script>
    </body>
    </html>
